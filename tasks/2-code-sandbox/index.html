<!DOCTYPE html>
<!-- Sample extended from https://docs.golem.network/creators/javascript/mid-level/examples/web/#allocation  -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Golem App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      type="module"
      src="https://unpkg.com/@fluentui/web-components"
    ></script>
  </head>
  <body class="w-screen h-screen grid grid-rows-[auto_1fr] gap-3 p-4">
    <div class="flex flex-row items-center justify-between">
      <div>Golem Code Sandbox</div>
      <fluent-text-field appearance="outline" class="outline-none" placeholder="YAGNA_APP_KEY" id="appid" ></fluent-text-field>
    </div>
    <div class="w-full h-full grid grid-cols-[1fr_minmax(20%,auto)] gap-2">
      <div class="p-1 w-full h-full relative">
        <div
          class="absolute right-0 p-2 mx-3 my-2 shadow rounded-lg flex flex-row items-center justify-center gap-2"
        >
          <fluent-select
            title="Select a section"
            class="outline-none min-w-fit"
            id="runtime"
            onchange="selectRuntime(this.value)"
          >
            <fluent-option value="shell">Shell</fluent-option>
            <fluent-option value="js">JS</fluent-option>
          </fluent-select>
        </div>
        <label class="w-full h-full">
          <textarea
            id="code"
            class="w-full h-full border-2 border-gray-100 focus:outline-gray-200 outline-none rounded-lg"
          ></textarea>
        </label>
      </div>
      <div class="flex flex-col items-center justify-between p-1">
        <div class="w-full flex flex-col gap-4">
          <div class="w-full flex flex-col">
            <fluent-label class="text-base mb-1"
              >Choose your Sandbox</fluent-label
            >
            <fluent-select
              title="Select a section"
              class="outline-none"
              onchange="selectSandbox(this.value)"
            >
              <fluent-option value="shell">vanilla</fluent-option>
              <fluent-option value="node">node:latest</fluent-option>
              <fluent-option value="python">python:latest</fluent-option>
            </fluent-select>
          </div>
          <fluent-button id="run">Run Code</fluent-button>
        </div>
        <div class="w-full p-2">
          <fluent-accordion-item
            class="p-1 rounded-lg border-2 border-slate-100 mb-2"
          >
            <span slot="heading">Output</span>
            <div
              class="panel w-full min-h-[5rem] p-2 border-2 border-slate-100 mb-2 outline-none"
            >
              <div id="output"></div>
            </div>
            <fluent-button onclick="downloadOutput()"
              >Download Output</fluent-button
            >
          </fluent-accordion-item>
          <fluent-accordion-item
            class="p-1 rounded-lg border-2 border-slate-100"
          >
            <span slot="heading">Logs</span>
            <div
              class="panel w-full min-h-[5rem] p-2 border-2 border-slate-100 mb-2 outline-none"
            >
              <div id="logs"></div>
            </div>
          </fluent-accordion-item>
        </div>
      </div>
    </div>
    <script>

      // Config variables
      let code, runtime,sandbox,appkey = '';

      // Unable to pass yagna appkey around thus triggering process
      // const process = {env: {
      //     YAGNA_APPKEY: appkey
      //   }}

      // Actions
      const selectSandbox = (value) =>{
        sandbox = value;
      }
      const selectRuntime = (e) =>{
        switch (e) {
          default:
            runtime = 'shell'
        }
      }

      document.getElementById('appid').addEventListener('input',(ev) => {
        appkey = ev.target.value
      })
      document.getElementById('code').addEventListener('input',(ev) => {
        code = ev.target.value;
      })

      // Outputs
      function appendLog(msg, level = 'info') {
        const logs = document.getElementById('logs');
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(`[${new Date().toISOString()}] [${level}] ${msg}`));
        logs.appendChild(div);
      }
      const logger = {
        log: (msg) => appendLog(msg),
        warn: (msg) => appendLog(msg, 'warn'),
        debug: (msg) => appendLog(msg, 'debug'),
        error: (msg) => appendLog(msg, 'error'),
        info: (msg) => appendLog(msg, 'info'),
        table: (msg) => appendLog(JSON.stringify(msg, null, "\t")),
      }

      function appendResults(result) {
        const results = document.getElementById('output');
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(JSON.stringify(result)));
        results.appendChild(div);
      }

    </script>
    <script type="module">
      import {
        Allocation,
        Package,
        Run,
        Script,
        Accounts,
        Demand, DemandEventType, Agreement, Activity, Deploy, Start
      } from "https://unpkg.com/yajsapi@0.7.0-alpha.0/dist/yajsapi.min.js";

      // Yagna Engine
      const yagnaOptions = { apiKey: appkey, basePath: 'http://localhost:7465' };


      let vmPackage,
              account,
              allocation,
              demand,
              proposals = [],
              offer,
              agreement,
              activity;


      async function createPackage() {
        vmPackage = await Package.create({ imageHash: "9a3b5d67b0b27746283cb5f287c13eab1beaa12d92a9f536b747c7ae", logger });
      }


      async function createAllocation() {
        const accounts = await (await Accounts.create({ yagnaOptions:yagnaOptions, logger })).list();
        account = accounts.find((account) => account?.platform === 'erc20-rinkeby-tglm');
        if (!account) logger.error("There is no available account");
        allocation = await Allocation.create({ account, yagnaOptions, logger }).catch(logger.error);
      }


      async function createDemand() {
        demand = await Demand.create(vmPackage, [allocation]).catch(logger.error);
        demand.addEventListener(DemandEventType, async (event) => {
          if (event.proposal.isInitial()) {
            proposals.push(event.proposal);
            logger.debug(`New proposal has been received (${event.proposal.id.slice(0,10)})`);
          } else if (event.proposal.isDraft()) {
            offer = event.proposal;
            logger.debug(`New offer has been received (${event.proposal.id.slice(0,10)})`);
          }
        })
      }


      async function respondProposal() {
        const proposal = proposals.shift();
        if (!proposal) logger.error('Ther is no available proposal');
        await proposal.respond(account.platform).catch(logger.error);
      }


      async function createAgreement() {
        agreement = await Agreement.create(offer.id, { yagnaOptions }).catch(logger.error);
      }

      async function confirmAgreement() {
        await agreement.confirm().catch(logger.error);
      }


      async function createActivity() {
        const state = await agreement.getState().catch(logger.error)
        if (state !== 'Approved') return logger.error(`Agreement is not approved. Current state: ${state}`)
        activity = await Activity.create(agreement.id).catch(logger.error);
        const script = await Script.create([new Deploy(), new Start()]);
        const exeScript = script.getExeScriptRequest();
        await activity.execute(exeScript).catch(logger.error);
      }

      async function runSandbox() {
        const script = await Script.create([new Run("/bin/sh", ["-c", code])]);
        const exeScript = script.getExeScriptRequest();
        const results = await activity.execute(exeScript).catch(logger.error);
        results.on('data', result => appendResults(result));
        results.on('error', error => appendLog(error));
      }

      async function end() {
        await activity.stop().catch(logger.error);
        await agreement.terminate().catch(logger.error);
        await allocation.release().catch(logger.error);
        await demand.unsubscribe().catch(logger.error);
        vmPackage = null;
        activity = null;
        agreement = null;
        allocation = null;
        demand = null;
        proposals = [];
        offer = null;
      }

      document.getElementById('run').addEventListener('click',() => run())

      const downloadOutput = () => {}
      const run = () => {
        createPackage().then(() => createAllocation()).then(() => createDemand()).then(() => respondProposal()).then(() => createAgreement()).then(() => confirmAgreement()).then(() => createActivity()).then(() => runSandbox()).then(() => end())
      }
    </script>
  </body>
</html>
